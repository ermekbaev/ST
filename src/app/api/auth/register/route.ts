// Ð£Ð»ÑƒÑ‡ÑˆÐµÐ½Ð½Ð°Ñ Ð²ÐµÑ€ÑÐ¸Ñ /app/api/auth/register/route.ts Ñ Ð´ÐµÑ‚Ð°Ð»ÑŒÐ½Ð¾Ð¹ Ð¾Ñ‚Ð»Ð°Ð´ÐºÐ¾Ð¹
import { NextResponse } from 'next/server';

interface RegisterRequest {
  phone: string;
  email: string;
  agreeToMarketing: boolean;
}

const STRAPI_URL = process.env.NEXT_PUBLIC_STRAPI_URL || 'http://localhost:1337';
const TEMP_PASSWORD = 'TigrShop2025!';

export async function POST(request: Request) {
  try {
    const body: RegisterRequest = await request.json();
    console.log('ðŸ“ === ÐÐÐ§ÐÐ›Ðž Ð Ð•Ð“Ð˜Ð¡Ð¢Ð ÐÐ¦Ð˜Ð˜ ===');
    console.log('ðŸ“Š Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð¾Ñ‚ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°:', {
      email: body.email,
      phone: body.phone,
      agreeToMarketing: body.agreeToMarketing,
      agreeToMarketingType: typeof body.agreeToMarketing
    });

    // Ð’Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ…
    const validation = validateRegistrationData(body);
    if (!validation.isValid) {
      return NextResponse.json({
        success: false,
        error: validation.error,
        field: validation.field
      }, { status: 400 });
    }

    // Ð¨ÐÐ“ 1: Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð±Ð°Ð·Ð¾Ð²Ð¾Ð³Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
    console.log('ðŸ”§ Ð¨ÐÐ“ 1: Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð±Ð°Ð·Ð¾Ð²Ð¾Ð³Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ...');
    const registerPayload = {
      username: body.email,
      email: body.email,
      password: TEMP_PASSWORD
    };
    console.log('ðŸ“¤ Payload Ð´Ð»Ñ Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ð¸:', registerPayload);

    const registerResponse = await fetch(`${STRAPI_URL}/api/auth/local/register`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(registerPayload),
    });

    const userData = await registerResponse.json();
    console.log('ðŸ“¥ ÐžÑ‚Ð²ÐµÑ‚ Strapi Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ð¸:', userData);

    if (!registerResponse.ok) {
      console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ:', userData);
      
      let error = 'ÐžÑˆÐ¸Ð±ÐºÐ° Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ð¸';
      let field = '';

      if (userData.error?.message?.includes('email') || userData.error?.message?.includes('Email')) {
        error = 'ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ñ Ñ‚Ð°ÐºÐ¸Ð¼ email ÑƒÐ¶Ðµ Ð·Ð°Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð¸Ñ€Ð¾Ð²Ð°Ð½';
        field = 'email';
      } else if (userData.error?.message?.includes('username')) {
        error = 'ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ñ Ñ‚Ð°ÐºÐ¸Ð¼ email ÑƒÐ¶Ðµ Ð·Ð°Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð¸Ñ€Ð¾Ð²Ð°Ð½';
        field = 'email';
      }

      return NextResponse.json({
        success: false,
        error,
        field
      }, { status: 409 });
    }

    console.log('âœ… Ð‘Ð°Ð·Ð¾Ð²Ñ‹Ð¹ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ÑÐ¾Ð·Ð´Ð°Ð½:', userData.user.id);

    // Ð¨ÐÐ“ 2: ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¼Ð¸ Ð¿Ð¾Ð»ÑÐ¼Ð¸
    console.log('ðŸ”§ Ð¨ÐÐ“ 2: ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ñ...');
    const updatePayload = {
      phone: body.phone,
      agreeToMarketing: Boolean(body.agreeToMarketing), // Ð¯Ð²Ð½Ð¾Ðµ Ð¿Ñ€ÐµÐ¾Ð±Ñ€Ð°Ð·Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð² Boolean
      registrationDate: new Date().toISOString(),
      lastLogin: new Date().toISOString()
    };
    console.log('ðŸ“¤ Payload Ð´Ð»Ñ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ:', updatePayload);

    const updateResponse = await fetch(`${STRAPI_URL}/api/users/${userData.user.id}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${userData.jwt}`,
      },
      body: JSON.stringify(updatePayload),
    });

    const updateResult = await updateResponse.json();
    console.log('ðŸ“¥ ÐžÑ‚Ð²ÐµÑ‚ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ:', updateResult);

    if (!updateResponse.ok) {
      console.error('âš ï¸ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ñ:', updateResult);
      // ÐŸÑ€Ð¾Ð´Ð¾Ð»Ð¶Ð°ÐµÐ¼, Ð½Ð¾ Ð¾Ñ‚Ð¼ÐµÑ‡Ð°ÐµÐ¼ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñƒ
    } else {
      console.log('âœ… ÐŸÑ€Ð¾Ñ„Ð¸Ð»ÑŒ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½');
    }

    // Ð¨ÐÐ“ 3: ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ„Ð¸Ð½Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ
    console.log('ðŸ”§ Ð¨ÐÐ“ 3: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…...');
    const checkResponse = await fetch(`${STRAPI_URL}/api/users/me`, {
      headers: {
        'Authorization': `Bearer ${userData.jwt}`,
      },
    });

    if (checkResponse.ok) {
      const finalUser = await checkResponse.json();
      console.log('ðŸ“Š Ð¤Ð˜ÐÐÐ›Ð¬ÐÐ«Ð• Ð”ÐÐÐÐ«Ð• Ð’ STRAPI:', {
        id: finalUser.id,
        email: finalUser.email,
        phone: finalUser.phone,
        agreeToMarketing: finalUser.agreeToMarketing,
        agreeToMarketingType: typeof finalUser.agreeToMarketing
      });
    } else {
      console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð´Ð°Ð½Ð½Ñ‹Ñ…:', await checkResponse.json());
    }

    // Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ ÑƒÑÐ¿ÐµÑˆÐ½Ñ‹Ð¹ Ð¾Ñ‚Ð²ÐµÑ‚
    console.log('ðŸŽ‰ === Ð Ð•Ð“Ð˜Ð¡Ð¢Ð ÐÐ¦Ð˜Ð¯ Ð—ÐÐ’Ð•Ð Ð¨Ð•ÐÐ ===');
    return NextResponse.json({
      success: true,
      message: 'Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ ÑƒÑÐ¿ÐµÑˆÐ½Ð°! Ð”Ð°Ð½Ð½Ñ‹Ðµ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ñ‹ Ð² Strapi.',
      user: {
        id: userData.user.id,
        email: userData.user.email,
        phone: body.phone,
        agreeToMarketing: Boolean(body.agreeToMarketing)
      },
      savedToSheets: true,
      jwt: userData.jwt
    });

  } catch (error) {
    console.error('âŒ ÐšÐ Ð˜Ð¢Ð˜Ð§Ð•Ð¡ÐšÐÐ¯ ÐžÐ¨Ð˜Ð‘ÐšÐ Ð Ð•Ð“Ð˜Ð¡Ð¢Ð ÐÐ¦Ð˜Ð˜:', error);
    return NextResponse.json({
      success: false,
      error: 'Ð’Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½ÑÑ Ð¾ÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°'
    }, { status: 500 });
  }
}

// Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ð¸ (Ñ‚Ðµ Ð¶Ðµ)
function validateRegistrationData(data: RegisterRequest): { isValid: boolean; error?: string; field?: string } {
  if (!data.email || !validateEmail(data.email)) {
    return { isValid: false, error: 'ÐÐµÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ñ‹Ð¹ email Ð°Ð´Ñ€ÐµÑ', field: 'email' };
  }

  if (!data.phone || !validatePhone(data.phone)) {
    return { isValid: false, error: 'ÐÐµÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ñ‹Ð¹ Ð½Ð¾Ð¼ÐµÑ€ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½Ð°', field: 'phone' };
  }

  return { isValid: true };
}

function validateEmail(email: string): boolean {
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return emailRegex.test(email);
}

function validatePhone(phone: string): boolean {
  const cleanPhone = phone.replace(/[^\d+]/g, '');
  return cleanPhone.length >= 10 && cleanPhone.length <= 12;
}